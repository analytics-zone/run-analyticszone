(function(){'use strict';class CRSCalculator{constructor(){this.form=document.getElementById('cssCalculatorForm');this.timeLongInput=document.getElementById('timeLong');this.timeShortInput=document.getElementById('timeShort');this.calculateBtn=document.getElementById('calculateBtn');this.resetBtn=document.getElementById('resetBtn');this.resultsContainer=document.getElementById('cssResults');this.crsValueEl=document.getElementById('cssValue');this.crsPaceEl=document.getElementById('cssPace');this.zonesTableEl=document.getElementById('zonesTable');this.trainingZones=[{name:'Zone 1: Recovery',min:120,max:130,description:'Active recovery, light aerobic maintenance'},{name:'Zone 2: Aerobic Base',min:108,max:120,description:'Build aerobic capacity, fat oxidation'},{name:'Zone 3: Tempo',min:102,max:108,description:'Marathon pace training, muscular endurance'},{name:'Zone 4: Threshold',min:97,max:102,description:'CRS pace, lactate threshold improvement'},{name:'Zone 5: VO₂max',min:0,max:97,description:'Interval training, VO₂max development'}];this.init();}
init(){if(!this.form)return;this.attachEventListeners();this.loadSavedData();}
attachEventListeners(){this.form.addEventListener('submit',(e)=>{e.preventDefault();this.calculate();});this.form.addEventListener('reset',()=>{this.clearResults();this.clearErrors();localStorage.removeItem('crs_calculator_data');});[this.timeLongInput,this.timeShortInput].forEach(input=>{if(input){input.addEventListener('input',(e)=>this.formatTimeInput(e));input.addEventListener('blur',(e)=>this.validateTimeInput(e));}});}
formatTimeInput(e){let value=e.target.value.replace(/[^0-9:]/g,'');if(value.length===1&&parseInt(value)>9){value=value+':';}else if(value.length===2&&!value.includes(':')){value=value+':';}
e.target.value=value;}
validateTimeInput(e){const input=e.target;const value=input.value.trim();this.clearError(input);if(!value)return true;const timeRegex=/^([0-9]{1,2}):([0-5][0-9])$/;const match=value.match(timeRegex);if(!match){this.showError(input,'Invalid format. Use mm:ss (e.g., 14:24)');return false;}
const minutes=parseInt(match[1]);const seconds=parseInt(match[2]);const totalSeconds=minutes*60+seconds;const isLong=input.id==='timeLong';if(isLong&&(totalSeconds<600||totalSeconds>2400)){this.showError(input,'3600m time should be between 10:00 and 40:00');return false;}
if(!isLong&&(totalSeconds<180||totalSeconds>900)){this.showError(input,'1200m time should be between 3:00 and 15:00');return false;}
return true;}
showError(input,message){const errorEl=document.getElementById(input.id+'-error');input.classList.add('error');input.setAttribute('aria-invalid','true');if(errorEl){errorEl.textContent=message;}}
clearError(input){const errorEl=document.getElementById(input.id+'-error');input.classList.remove('error');input.removeAttribute('aria-invalid');if(errorEl){errorEl.textContent='';}}
clearErrors(){[this.timeLongInput,this.timeShortInput].forEach(input=>{if(input)this.clearError(input);});}
parseTimeToSeconds(timeStr){const match=timeStr.match(/^([0-9]{1,2}):([0-5][0-9])$/);if(!match)return null;const minutes=parseInt(match[1]);const seconds=parseInt(match[2]);return minutes*60+seconds;}
formatSecondsToTime(totalSeconds){const minutes=Math.floor(totalSeconds/60);const seconds=Math.round(totalSeconds%60);return`${minutes}:${seconds.toString().padStart(2, '0')}`;}
calculate(){this.clearErrors();const timeLongValid=this.validateTimeInput({target:this.timeLongInput});const timeShortValid=this.validateTimeInput({target:this.timeShortInput});if(!timeLongValid||!timeShortValid){return;}
const timeLongStr=this.timeLongInput.value.trim();const timeShortStr=this.timeShortInput.value.trim();if(!timeLongStr||!timeShortStr){if(!timeLongStr)this.showError(this.timeLongInput,'Required field');if(!timeShortStr)this.showError(this.timeShortInput,'Required field');return;}
const tLong=this.parseTimeToSeconds(timeLongStr);const tShort=this.parseTimeToSeconds(timeShortStr);if(tLong===null||tShort===null){return;}
const paceLongPerKm=tLong/3.6;const paceShortPerKm=tShort/1.2;if(paceLongPerKm<=paceShortPerKm){this.showError(this.timeLongInput,'3600m pace must be slower than 1200m pace. Check your times.');return;}
const dShort=1200;const dLong=3600;const crsMetersPerSecond=(dLong-dShort)/(tLong-tShort);const crsPacePer100m=100/crsMetersPerSecond;this.displayResults(crsMetersPerSecond,crsPacePer100m);this.saveData({timeLong:timeLongStr,timeShort:timeShortStr});}
displayResults(crsMS,crsPace){this.resultsContainer.style.display='block';this.crsValueEl.textContent=`${crsMS.toFixed(3)} m/s`;this.crsPaceEl.textContent=this.formatSecondsToTime(crsPace);this.generateZonesTable(crsPace);this.resultsContainer.scrollIntoView({behavior:'smooth',block:'nearest'});}
generateZonesTable(crsPace){const table=document.createElement('table');table.className='zones-table';const thead=document.createElement('thead');thead.innerHTML=`
        <tr>
          <th>Zone</th>
          <th>% of CRS</th>
          <th>Pace Range</th>
          <th>Purpose</th>
        </tr>
      `;table.appendChild(thead);const tbody=document.createElement('tbody');this.trainingZones.forEach((zone,index)=>{const minPace=(crsPace*zone.min)/100;const maxPace=(crsPace*zone.max)/100;const row=document.createElement('tr');row.className=`zone-${index + 1}`;let paceRange;if(zone.min===0){paceRange=`< ${this.formatSecondsToTime(maxPace)}`;}else if(zone.min>120){paceRange=`> ${this.formatSecondsToTime(maxPace)}`;}else{paceRange=`${this.formatSecondsToTime(maxPace)} - ${this.formatSecondsToTime(minPace)}`;}
row.innerHTML=`
          <td><strong>${zone.name}</strong></td>
          <td>${zone.min === 0 ? '<' + zone.max : zone.min === 120 ? '>' + zone.min : zone.min + '-' + zone.max}%</td>
          <td>${paceRange}</td>
          <td>${zone.description}</td>
        `;tbody.appendChild(row);});table.appendChild(tbody);this.zonesTableEl.innerHTML='';this.zonesTableEl.appendChild(table);}
clearResults(){this.resultsContainer.style.display='none';this.crsValueEl.textContent='--';this.crsPaceEl.textContent='--';this.zonesTableEl.innerHTML='';}
saveData(data){try{localStorage.setItem('crs_calculator_data',JSON.stringify(data));}catch(e){console.error('Failed to save calculator data:',e);}}
loadSavedData(){try{const savedData=localStorage.getItem('crs_calculator_data');if(savedData){const data=JSON.parse(savedData);if(data.timeLong)this.timeLongInput.value=data.timeLong;if(data.timeShort)this.timeShortInput.value=data.timeShort;if(data.timeLong&&data.timeShort)this.calculate();}}catch(e){console.error('Failed to load saved data:',e);}}}
function initCalculator(){const calculator=new CRSCalculator();}
if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initCalculator);}else{initCalculator();}})();